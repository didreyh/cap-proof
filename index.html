<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tatak JPD - Packing Proof</title>

  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f3f4f6;
      min-height:100vh;
      padding:18px;
    }
    .wrap{
      max-width:820px;
      margin:0 auto;
    }
    .card{
      background:white;
      border-radius:22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding:18px;
      margin-bottom:16px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:6px 6px 12px;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:12px;
    }
    .title{
      font-weight:900;
      font-size:28px;
      line-height:1.1;
    }
    .subtitle{
      margin-top:6px;
      color:#6b7280;
      font-size:14px;
    }
    .logout{
      border:none;
      background:#0b0b0b;
      color:white;
      border-radius:16px;
      padding:12px 16px;
      font-weight:800;
      cursor:pointer;
    }
    .pill{
      background:#ecfdf5;
      border:1px solid #bbf7d0;
      padding:10px 12px;
      border-radius:14px;
      color:#065f46;
      font-size:14px;
      margin:8px 0 0;
      word-break:break-all;
    }
    h2{
      margin:10px 0 10px;
      font-size:22px;
    }
    label{
      display:block;
      font-weight:800;
      margin:10px 0 6px;
    }
    input[type="text"], textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid #d1d5db;
      border-radius:14px;
      padding:14px;
      font-size:16px;
      outline:none;
    }
    input[type="text"]:focus, textarea:focus{
      border-color:#111827;
      box-shadow:0 0 0 4px rgba(17,24,39,.08);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .btn{
      border:none;
      border-radius:16px;
      padding:14px 16px;
      font-weight:900;
      cursor:pointer;
    }
    .btn-dark{
      background:#0b0b0b;
      color:white;
    }
    .btn-light{
      background:#f3f4f6;
      color:#111827;
    }
    .status{
      margin-top:10px;
      color:#111827;
      font-size:14px;
      min-height:18px;
    }
    .hint{
      color:#6b7280;
      font-size:13px;
      margin-top:6px;
    }

    /* radio "box" UI */
    .choices{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }
    .choice{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid #d1d5db;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      background:white;
    }
    .choice input{ transform: scale(1.2); }
    .choice strong{ font-weight:900; }

    .divider{ height:1px; background:#e5e7eb; margin:16px 0; }

    .preview{
      width:100%;
      max-height:520px;
      object-fit:contain;
      border-radius:16px;
      border:1px solid #e5e7eb;
      background:#fafafa;
    }

    textarea{
      min-height:140px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:14px;
    }

    .footer{
      text-align:center;
      color:#9ca3af;
      font-size:12px;
      margin-top:12px;
    }
  </style>

  <!-- Firebase v8 compat -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="./firebase.js"></script>
</head>

<body>
  <div class="wrap">

    <!-- Top card -->
    <div class="card">
      <div class="topbar">
        <div>
          <div class="title">ðŸ“¦ Tatak JPD â€“ Packing Proof</div>
          <div class="subtitle">Type/Scan AWB â†’ if no record, create entry â†’ photo proof â†’ copy message</div>
          <div class="pill" id="userPill">Checking login...</div>
        </div>
        <button class="logout" id="logoutBtn">Logout</button>
      </div>

      <h2>Search / Scan AWB</h2>

      <label>AWB Number</label>
      <input id="awbInput" type="text" placeholder="Type or paste AWB number" inputmode="numeric" />

      <div class="row">
        <button class="btn btn-dark" id="continueBtn">Continue</button>
        <span class="hint">Tip: sa PC pwede paste + Enter. Sa phone pwede type/scan.</span>
      </div>

      <div class="status" id="statusText"></div>
    </div>

    <!-- Create entry section -->
    <div class="card" id="createSection" style="display:none;">
      <h2>Create New Entry</h2>

      <label>AWB</label>
      <input id="createAwb" type="text" readonly />

      <label>Level</label>
      <div class="choices">
        <label class="choice"><input type="radio" name="level" value="Kinder"><strong>Kinder</strong></label>
        <label class="choice"><input type="radio" name="level" value="Elem"><strong>Elem</strong></label>
        <label class="choice"><input type="radio" name="level" value="SHS"><strong>SHS</strong></label>
      </div>

      <label>Cap Color (one choice)</label>
      <div class="choices">
        <label class="choice"><input type="radio" name="capColor" value="White"><strong>White</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Light Blue"><strong>Light Blue</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Fuchsia Pink"><strong>Fuchsia Pink</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Royal Blue"><strong>Royal Blue</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Black"><strong>Black</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Yellow Gold"><strong>Yellow Gold</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Emerald Green"><strong>Emerald Green</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Red"><strong>Red</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Maroon"><strong>Maroon</strong></label>
        <label class="choice"><input type="radio" name="capColor" value="Apple Green"><strong>Apple Green</strong></label>
      </div>

      <label>Photo Proof</label>
      <input id="photoInput" type="file" accept="image/*" />

      <div class="row">
        <button class="btn btn-dark" id="saveBtn">Save Packing Log</button>
        <button class="btn btn-light" id="cancelBtn">Cancel</button>
      </div>

      <div class="status" id="saveStatus"></div>
      <div class="hint">If "Double AWB" lumabas, ibig sabihin may record na siya.</div>
    </div>

    <!-- Result section -->
    <div class="card" id="resultSection" style="display:none;">
      <h2>Result</h2>

      <div class="hint">
        AWB: <strong id="resultAwb"></strong> â€¢ Packed on: <strong id="resultPackedOn"></strong>
        <br/>Level: <strong id="resultLevel"></strong> â€¢ Color: <strong id="resultColor"></strong>
      </div>

      <div class="divider"></div>

      <img id="resultPhoto" class="preview" alt="Packing proof photo" />

      <div class="divider"></div>

      <label>Copy-ready message</label>
      <textarea id="copyMessage"></textarea>

      <div class="row">
        <button class="btn btn-dark" id="copyBtn">Copy Message</button>
      </div>

      <div class="status" id="copyStatus"></div>
    </div>

    <div class="footer">Private system â€” login required â€¢ Stored in Firebase (Auth + Firestore + Storage)</div>
  </div>

  <script>
    const userPill   = document.getElementById("userPill");
    const statusText = document.getElementById("statusText");
    const saveStatus = document.getElementById("saveStatus");
    const copyStatus = document.getElementById("copyStatus");

    const awbInput   = document.getElementById("awbInput");
    const createAwb  = document.getElementById("createAwb");

    const createSection = document.getElementById("createSection");
    const resultSection = document.getElementById("resultSection");

    const continueBtn = document.getElementById("continueBtn");
    const saveBtn     = document.getElementById("saveBtn");
    const cancelBtn   = document.getElementById("cancelBtn");
    const logoutBtn   = document.getElementById("logoutBtn");

    const photoInput  = document.getElementById("photoInput");

    function setStatus(msg){ statusText.textContent = msg || ""; }
    function setSaveStatus(msg){ saveStatus.textContent = msg || ""; }
    function setCopyStatus(msg){ copyStatus.textContent = msg || ""; }

    function showCreateForm(awb){
      createSection.style.display = "block";
      createAwb.value = awb;

      // reset picks
      document.querySelectorAll('input[name="level"]').forEach(r=>r.checked=false);
      document.querySelectorAll('input[name="capColor"]').forEach(r=>r.checked=false);
      photoInput.value = "";
      setSaveStatus("");
    }
    function hideCreateForm(){ createSection.style.display="none"; }
    function hideResult(){ resultSection.style.display="none"; }

    function showResultFromData(awb, d){
      resultSection.style.display="block";
      document.getElementById("resultAwb").innerText = awb;
      document.getElementById("resultLevel").innerText = d.level || "-";
      document.getElementById("resultColor").innerText = d.color || "-";
      document.getElementById("resultPhoto").src = d.imageUrl || "";

      let packedOn = "Saved (timestamp pending)";
      try {
        if(d.createdAt && d.createdAt.toDate) packedOn = d.createdAt.toDate().toLocaleString("en-PH");
      } catch(e){}

      document.getElementById("resultPackedOn").innerText = packedOn;

      document.getElementById("copyMessage").value =
`Hi po! ðŸ˜Š Ready to ship na po ang order nyo.

ðŸ“¦ AWB: ${awb}
ðŸ·ï¸ Level: ${d.level || "-"}
ðŸŽ¨ Cap Color: ${d.color || "-"}
ðŸ•’ Packed on: ${packedOn}

Thank you po!
â€“ Tatak JPD`;
    }

    // Auth guard
    auth.onAuthStateChanged(user=>{
      if(!user){
        window.location.href = "./login.html";
        return;
      }
      userPill.textContent = "Logged in as: " + (user.email || user.uid);
    });

    logoutBtn.addEventListener("click", async ()=>{
      await auth.signOut();
      window.location.href = "./login.html";
    });

    // âœ… MAIN FLOW: check existing first; if none, show create form
    async function checkOrCreateAWB(){
      const awb = awbInput.value.trim();
      if(!awb) return alert("Enter/scan AWB muna.");

      hideResult();
      hideCreateForm();
      setStatus("Checking AWB...");

      try{
        const ref = db.collection("packingLogs").doc(awb); // docId = AWB
        const snap = await ref.get();

        if(snap.exists){
          setStatus("");
          alert("âš ï¸ Double AWB! May record na ito. Please check, already has parcel.");
          showResultFromData(awb, snap.data());
          return;
        }

        setStatus("");
        showCreateForm(awb);
      }catch(err){
        setStatus("");
        alert(err.message || "Error checking AWB");
      }
    }

    continueBtn.addEventListener("click", checkOrCreateAWB);

    // Enter key = Continue
    awbInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        checkOrCreateAWB();
      }
    });

    cancelBtn.addEventListener("click", ()=>{
      hideCreateForm();
      setSaveStatus("");
    });

    async function saveNewPackingLog(){
      const awb = createAwb.value.trim();
      if(!awb) return alert("Missing AWB.");

      const level = document.querySelector('input[name="level"]:checked')?.value;
      const color = document.querySelector('input[name="capColor"]:checked')?.value;
      if(!level) return alert("Pili ka muna: Kinder / Elem / SHS");
      if(!color) return alert("Pili ka muna ng color.");

      const file = photoInput.files?.[0];
      if(!file) return alert("Upload photo muna.");

      const user = auth.currentUser;
      if(!user) return alert("Not logged in.");

      setSaveStatus("Uploading photo + saving...");

      try{
        // double-check
        const ref = db.collection("packingLogs").doc(awb);
        const snap = await ref.get();
        if(snap.exists){
          setSaveStatus("");
          alert("âš ï¸ Double AWB! May record na ito. Please check.");
          showResultFromData(awb, snap.data());
          hideCreateForm();
          return;
        }

        // Upload to storage
        const uid = user.uid;
        const path = `packingProofs/${uid}/${awb}.jpg`;
        const storageRef = storage.ref().child(path);

        await storageRef.put(file);
        const imageUrl = await storageRef.getDownloadURL();

        const data = {
          awb,
          level,
          color,
          imageUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: user.email || uid
        };

        await ref.set(data);

        setSaveStatus("");
        alert("âœ… Saved! May record na si AWB.");
        hideCreateForm();

        // fetch again to get timestamp resolved
        const snap2 = await ref.get();
        showResultFromData(awb, snap2.data() || data);

      }catch(err){
        setSaveStatus("");
        alert(err.message || "Save failed");
      }
    }

    saveBtn.addEventListener("click", saveNewPackingLog);

    // Copy button
    document.getElementById("copyBtn").addEventListener("click", async ()=>{
      try{
        const text = document.getElementById("copyMessage").value;
        await navigator.clipboard.writeText(text);
        setCopyStatus("âœ… Copied!");
        setTimeout(()=>setCopyStatus(""), 1200);
      }catch(e){
        setCopyStatus("Copy failed (try manual long-press).");
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tatak JPD â€“ Packing Proof</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ZXing for barcode scan -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <style>
    body{font-family:Arial,sans-serif;background:#f5f6f8;padding:20px}
    .card{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h2,h3{margin:0 0 8px}
    .muted{color:#666;font-size:13px}
    .section{margin-top:22px}
    input,textarea,button{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid #ddd;font-size:15px}
    button{background:#111;color:#fff;border:none;font-weight:700;cursor:pointer}
    button.secondary{background:#eee;color:#111}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    img{max-width:100%;border-radius:12px;margin-top:10px;border:1px solid #eee}
    .box{background:#fafafa;border:1px solid #eee;padding:12px;border-radius:12px;margin-top:10px}
    .success{color:#0a7a2f;font-weight:700;margin-top:6px}
    video{width:100%;border-radius:12px;background:#000}
  </style>
</head>

<body>
<div class="card">
  <h2>ðŸ“¦ Tatak JPD â€“ Packing Proof</h2>
  <p class="muted">Type/Scan AWB â†’ view photo â†’ copy message â†’ daily summary</p>

  <!-- SEARCH / SCAN -->
  <div class="section">
    <h3>Search / Scan AWB</h3>
    <input id="awbInput" placeholder="Type or paste AWB number" />

    <div class="row">
      <button id="scanBtn" type="button">ðŸ“· Scan AWB</button>
      <button id="searchBtn" type="button" class="secondary">Search</button>
    </div>

    <div id="scanBox" class="box" style="display:none">
      <p class="muted">Allow camera access then point to barcode</p>
      <video id="preview" playsinline></video>
      <button id="stopScanBtn" type="button" class="secondary">Stop Scan</button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="section" id="resultSection" style="display:none">
    <p><b>AWB:</b> <span id="awbText"></span></p>
    <p><b>Packed on:</b> <span id="timeText"></span></p>

    <img id="proofImage" />

    <label><b>Message to send</b></label>
    <textarea id="messageBox" rows="6"></textarea>
    <button id="copyBtn" type="button">ðŸ“‹ Copy message</button>
    <div id="copyStatus" class="success"></div>
  </div>

  <!-- DAILY SUMMARY -->
  <div class="section">
    <h3>ðŸ“Š Daily Summary</h3>
    <button id="summaryBtn" type="button" class="secondary">Load Today Summary</button>
    <div id="summaryBox" class="box"></div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // ðŸ”¥ Firebase config (yours)
  const firebaseConfig = {
    apiKey: "AIzaSyCMuFIBYcEWJCknOsA-hRctc6I7v4Sr_gU",
    authDomain: "cap-proof.firebaseapp.com",
    projectId: "cap-proof",
    storageBucket: "cap-proof.firebasestorage.app",
    messagingSenderId: "722260489486",
    appId: "1:722260489486:web:e4c8111afb86586f2fd35f"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Require login
  auth.onAuthStateChanged(u=>{
    if(!u) location.href="login.html";
  });

  const awbInput = document.getElementById("awbInput");
  const searchBtn = document.getElementById("searchBtn");

  // ENTER = SEARCH
  awbInput.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ e.preventDefault(); searchBtn.click(); }
  });

  // SEARCH
  async function searchAWB(){
    const awb = awbInput.value.trim();
    if(!awb) return alert("Enter AWB");

    const doc = await db.collection("packingLogs").doc(awb).get();
    if(!doc.exists) return alert("No record found");

    const d = doc.data();
    const timeText = d.createdAt?.toDate
      ? d.createdAt.toDate().toLocaleString("en-PH")
      : "N/A";

    document.getElementById("awbText").innerText = awb;
    document.getElementById("timeText").innerText = timeText;
    document.getElementById("proofImage").src = d.imageUrl;

    document.getElementById("messageBox").value =
`Hi po! ðŸ˜Š

Ready to ship na po ang order nyo.

ðŸ“¦ AWB: ${awb}
ðŸ•’ Packed on: ${timeText}

Thank you po!
â€“ Tatak JPD`;

    document.getElementById("resultSection").style.display="block";
  }
  searchBtn.onclick = searchAWB;

  // COPY
  document.getElementById("copyBtn").onclick = async ()=>{
    await navigator.clipboard.writeText(document.getElementById("messageBox").value);
    document.getElementById("copyStatus").innerText="âœ… Copied!";
  };

  // DAILY SUMMARY
  document.getElementById("summaryBtn").onclick = async ()=>{
    const box = document.getElementById("summaryBox");
    box.innerHTML="Loadingâ€¦";
    const now=new Date();
    const start=new Date(now.getFullYear(),now.getMonth(),now.getDate(),0,0,0);
    const end=new Date(now.getFullYear(),now.getMonth(),now.getDate(),23,59,59);

    const snap = await db.collection("packingLogs")
      .where("createdAt",">=",start)
      .where("createdAt","<=",end)
      .get();

    if(snap.empty){ box.innerHTML="Wala pang logs today."; return; }

    let html=`<b>Total today:</b> ${snap.size}<ul>`;
    snap.forEach(d=> html+=`<li>${d.id}</li>`);
    html+="</ul>";
    box.innerHTML=html;
  };

  // SCAN (ZXing)
  const scanBtn=document.getElementById("scanBtn");
  const stopScanBtn=document.getElementById("stopScanBtn");
  const scanBox=document.getElementById("scanBox");
  const preview=document.getElementById("preview");
  let codeReader;

  scanBtn.onclick = async ()=>{
    scanBox.style.display="block";
    if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
    codeReader.decodeFromVideoDevice(null, preview, (res,err)=>{
      if(res){
        awbInput.value = res.getText();
        codeReader.reset();
        scanBox.style.display="none";
        searchBtn.click();
      }
    });
  };

  stopScanBtn.onclick = ()=>{
    if(codeReader) codeReader.reset();
    scanBox.style.display="none";
  };
</script>
</body>
</html>
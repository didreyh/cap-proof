<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tatak JPD â€¢ Packing Logs</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#666; --btn:#111; --btnText:#fff; --line:#e8e8ef; --soft:#eef8f1; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;min-height:100vh;background:var(--bg);padding:18px;}
    .wrap{max-width:780px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:18px 18px 14px;}
    .top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;}
    h1{margin:0 0 2px;font-size:24px;display:flex;gap:10px;align-items:center;}
    .sub{margin:0;color:var(--muted);font-size:13px;}
    .logout{padding:10px 14px;border:0;border-radius:14px;background:var(--btn);color:var(--btnText);font-weight:800;cursor:pointer;}
    .pill{margin-top:10px;background:var(--soft);border:1px solid #cfe9d7;border-radius:12px;padding:10px 12px;color:#0a7a2f;font-size:13px;}
    hr{border:0;border-top:1px solid var(--line);margin:14px 0;}
    h2{margin:0 0 10px;font-size:22px;}
    label{display:block;margin:10px 0 6px;font-weight:700;}
    input[type="text"]{width:100%;padding:14px;border:1px solid var(--line);border-radius:12px;font-size:16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{padding:12px 14px;border:0;border-radius:14px;background:var(--btn);color:var(--btnText);font-weight:800;cursor:pointer;}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--line);}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .tip{color:var(--muted);font-size:13px;margin-top:8px;}
    .status{margin-top:10px;font-size:14px;color:var(--muted);}
    .err{margin-top:10px;color:#b00020;font-size:14px;white-space:pre-wrap;}
    .preview{margin-top:12px;border:1px dashed var(--line);border-radius:14px;overflow:hidden;background:#fafafa;display:grid;place-items:center;min-height:160px;}
    .preview img{width:100%;height:auto;display:block;}
    .result{margin-top:12px;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;}
    .result strong{display:block;margin-bottom:6px;}
    .small{font-size:12px;color:var(--muted);}
    .footer{margin-top:12px;text-align:center;color:var(--muted);font-size:12px;}
    #scannerModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;}
    #scannerBox{width:min(520px,100%);background:#fff;border-radius:16px;padding:14px;border:1px solid var(--line);}
    #scannerVideoWrap{border-radius:14px;overflow:hidden;background:#000;min-height:260px;display:grid;place-items:center;}
    #scannerVideo{width:100%;height:auto;}
    .modalTop{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .x{border:0;background:#fff;font-size:18px;cursor:pointer;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>âœ… Tatak JPD</h1>
          <p class="sub">Cap Packing & AWB Proof System</p>
        </div>
        <button id="logoutBtn" class="logout">Logout</button>
      </div>

      <div id="userPill" class="pill" style="display:none;"></div>

      <hr />

      <h2>Scan / Type AWB</h2>
      <label>AWB Number</label>
      <input id="awbInput" type="text" placeholder="Scan will fill thisâ€¦ or paste/type AWB" />

      <div class="tip">Tip: scan barcode para mabilis. Pwede rin paste/type kung kailangan.</div>

      <div class="row" style="margin-top:12px;">
        <button id="scanBtn" class="btn">ðŸ“· Scan AWB Barcode</button>
        <button id="searchBtn" class="btn secondary">Search</button>
      </div>

      <hr />

      <h2>Upload Picture Proof</h2>
      <label>Choose photo</label>
      <input id="photoInput" type="file" accept="image/*" />

      <div class="preview" id="previewBox">
        <div class="small">Preview will appear here</div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="saveBtn" class="btn">Save Packing Log</button>
      </div>

      <div id="status" class="status"></div>
      <div id="error" class="err" style="display:none;"></div>

      <hr />

      <h2>Search / View Logs</h2>
      <div class="tip">You can search anytime â€” kahit wala pang scan.</div>

      <div id="resultBox" class="result" style="display:none;"></div>

      <div class="footer">Private system â€” login required â€¢ Stored in Firebase (Auth + Firestore + Storage)</div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="scannerModal">
    <div id="scannerBox">
      <div class="modalTop">
        <strong>Scan Barcode</strong>
        <button class="x" id="closeScan">âœ•</button>
      </div>
      <div id="scannerVideoWrap">
        <video id="scannerVideo" playsinline></video>
      </div>
      <div class="tip" style="margin-top:10px;">Itutok sa barcode (J&T / SPX). Kapag nabasa, auto-fill na yung AWB.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // âœ… YOUR FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCMuFIBYcEWJCknOsA-hRctc6I7v4Sr_gU",
      authDomain: "cap-proof.firebaseapp.com",
      projectId: "cap-proof",
      storageBucket: "cap-proof.firebasestorage.app",
      messagingSenderId: "722260489486",
      appId: "1:722260489486:web:e4c8111afb86586f2fd35f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const logoutBtn = document.getElementById("logoutBtn");
    const userPill  = document.getElementById("userPill");
    const awbInput  = document.getElementById("awbInput");
    const searchBtn = document.getElementById("searchBtn");
    const scanBtn   = document.getElementById("scanBtn");
    const photoInput= document.getElementById("photoInput");
    const previewBox= document.getElementById("previewBox");
    const saveBtn   = document.getElementById("saveBtn");
    const statusEl  = document.getElementById("status");
    const errBox    = document.getElementById("error");
    const resultBox = document.getElementById("resultBox");

    const scannerModal = document.getElementById("scannerModal");
    const closeScanBtn = document.getElementById("closeScan");
    const videoEl = document.getElementById("scannerVideo");

    let currentUser = null;
    let selectedFile = null;
    let scanStream = null;
    let scanLoopRunning = false;

    function showError(msg){
      errBox.style.display="block";
      errBox.textContent = msg;
    }
    function clearError(){
      errBox.style.display="none";
      errBox.textContent = "";
    }
    function setStatus(msg){
      statusEl.textContent = msg || "";
    }

    // âœ… Require login
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "./login.html";
        return;
      }
      currentUser = user;
      userPill.style.display = "block";
      userPill.textContent = `Logged in as: ${user.email}`;
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "./login.html";
      } catch (e) {
        showError(e?.message || String(e));
      }
    });

    // âœ… Preview image
    photoInput.addEventListener("change", () => {
      clearError();
      setStatus("");
      selectedFile = photoInput.files?.[0] || null;
      previewBox.innerHTML = "";

      if (!selectedFile) {
        previewBox.innerHTML = `<div class="small">Preview will appear here</div>`;
        return;
      }
      const url = URL.createObjectURL(selectedFile);
      const img = document.createElement("img");
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);
      previewBox.appendChild(img);
    });

    // âœ… Normalize AWB
    function normalizeAwb(s){
      return (s || "")
        .trim()
        .replace(/\s+/g,"")
        .replace(/[^\w-]/g,"")
        .toUpperCase();
    }

    // âœ… Save packing log (picture only)
    saveBtn.addEventListener("click", async () => {
      clearError();
      resultBox.style.display = "none";

      const awb = normalizeAwb(awbInput.value);
      if (!awb) return showError("Please enter/scan AWB first.");
      if (!selectedFile) return showError("Please choose a photo proof.");

      saveBtn.disabled = true;
      setStatus("Uploading photo + saving...");

      try {
        // Upload to Storage
        const uid = currentUser.uid;
        const ext = (selectedFile.name.split(".").pop() || "jpg").toLowerCase();
        const safeExt = ["jpg","jpeg","png","webp","heic"].includes(ext) ? ext : "jpg";
        const path = `packingProofs/${uid}/${awb}/${Date.now()}.${safeExt}`;

        const fileRef = ref(storage, path);
        await uploadBytes(fileRef, selectedFile, { contentType: selectedFile.type || "image/jpeg" });
        const imageUrl = await getDownloadURL(fileRef);

        // Save to Firestore (doc id = AWB)
        await setDoc(doc(db, "packingLogs", awb), {
          awb,
          imageUrl,
          storagePath: path,
          createdAt: serverTimestamp(),
          createdByUid: uid,
          createdByEmail: currentUser.email || null,
          courierHint: "J&T / SPX / Flash Express"
        }, { merge: true });

        setStatus("âœ… Saved! You can search it below.");
        // Auto show result
        await runSearch(awb);

        // reset file
        selectedFile = null;
        photoInput.value = "";
      } catch (e) {
        showError(e?.message || String(e));
        setStatus("");
      } finally {
        saveBtn.disabled = false;
      }
    });

    // âœ… Search anytime
    async function runSearch(awb){
      clearError();
      setStatus("Searching...");
      resultBox.style.display = "none";
      const snap = await getDoc(doc(db, "packingLogs", awb));

      if (!snap.exists()) {
        setStatus("");
        resultBox.style.display = "block";
        resultBox.innerHTML = `
          <strong>No log found</strong>
          <div class="small">AWB: ${awb}</div>
          <div class="small">Try again or save a new proof.</div>
        `;
        return;
      }

      const data = snap.data();
      setStatus("");
      resultBox.style.display = "block";
      resultBox.innerHTML = `
        <strong>FOUND âœ…</strong>
        <div class="small"><b>AWB:</b> ${data.awb || awb}</div>
        <div class="small"><b>By:</b> ${data.createdByEmail || "-"}</div>
        <div class="small" style="margin-top:8px;">
          <img src="${data.imageUrl}" alt="proof" style="width:100%;border-radius:12px;border:1px solid #eee;" />
        </div>
      `;
    }

    searchBtn.addEventListener("click", async () => {
      clearError();
      const awb = normalizeAwb(awbInput.value);
      if(!awb) return showError("Type/paste AWB to search.");
      try {
        await runSearch(awb);
      } catch (e) {
        showError(e?.message || String(e));
        setStatus("");
      }
    });

    // =========================
    // SIMPLE BARCODE SCAN (camera)
    // =========================
    // NOTE: iOS Safari can be picky. If scan fails, manual paste still works.

    function openScanner(){
      scannerModal.style.display="flex";
    }
    async function closeScanner(){
      scannerModal.style.display="none";
      scanLoopRunning = false;
      if (scanStream) {
        scanStream.getTracks().forEach(t => t.stop());
        scanStream = null;
      }
      videoEl.srcObject = null;
    }

    closeScanBtn.addEventListener("click", closeScanner);

    scanBtn.addEventListener("click", async () => {
      clearError();
      try {
        openScanner();
        const constraints = { video: { facingMode: "environment" }, audio: false };
        scanStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = scanStream;
        await videoEl.play();

        // try BarcodeDetector if available
        if ("BarcodeDetector" in window) {
          const detector = new BarcodeDetector({ formats: ["code_128","code_39","ean_13","ean_8","upc_a","upc_e","itf","qr_code"] });
          scanLoopRunning = true;

          const loop = async () => {
            if (!scanLoopRunning) return;
            try {
              const barcodes = await detector.detect(videoEl);
              if (barcodes && barcodes.length) {
                const raw = barcodes[0].rawValue || "";
                const awb = normalizeAwb(raw);
                if (awb) {
                  awbInput.value = awb;
                  await closeScanner();
                  setStatus(`Scanned: ${awb}`);
                  return;
                }
              }
            } catch (e) {
              // ignore detection errors and continue
            }
            requestAnimationFrame(loop);
          };
          requestAnimationFrame(loop);
        } else {
          // Fallback message
          setStatus("Scanner not supported on this browser. Please type/paste AWB.");
        }
      } catch (e) {
        await closeScanner();
        showError("Camera error: " + (e?.message || String(e)));
      }
    });

  </script>
</body>
</html>
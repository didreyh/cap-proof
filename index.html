<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tatak JPD ‚Äî Packing Proof</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 18px 45px rgba(0,0,0,.12);
      --btn:#0b0b0b;
      --soft:#f9fafb;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 50% -10%, #ffffff 0%, var(--bg) 60%);
      color:var(--text);
      min-height:100vh;
      padding:24px;
    }
    .wrap{width:min(860px, 100%); margin:0 auto;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:26px;
    }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .title{
      display:flex; align-items:center; gap:10px;
    }
    .title h1{margin:0; font-size:34px; font-weight:900; line-height:1.05}
    .title .emoji{font-size:28px}
    .subtitle{margin:6px 0 0; color:var(--muted)}
    .btn{
      background:linear-gradient(180deg, #111 0%, #000 100%);
      color:#fff;
      border:none;
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      min-width:110px;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .status{
      margin:12px 0 18px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:#111;
      white-space:pre-wrap;
    }
    .status.ok{border-color:#bbf7d0; background:#ecfdf5;}
    .status.warn{border-color:#fde68a; background:#fffbeb;}
    .status.bad{border-color:#fecaca; background:#fef2f2;}
    hr{border:none; border-top:1px solid var(--border); margin:18px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{display:block; font-weight:900; margin:12px 0 8px}
    input[type="text"]{
      width:100%;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:14px;
      outline:none;
      font-size:16px;
      background:#fff;
    }
    input[type="text"]:focus{border-color:#c7cbd1; box-shadow:0 0 0 4px rgba(0,0,0,.06)}
    .hint{color:var(--muted); font-size:13px; margin-top:6px}
    .sectionTitle{
      font-size:22px; font-weight:1000; margin:0 0 6px;
    }
    .pillRow{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }
    .pill input{display:none}
    .pill.active{
      border-color:#111;
      box-shadow:0 0 0 4px rgba(0,0,0,.06);
    }
    .orderBox{
      border:1px dashed var(--border);
      border-radius:18px;
      padding:14px;
      background:var(--soft);
      margin-top:12px;
    }
    .orderHeader{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
      font-weight:1000;
    }
    .smallBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:700px){ .grid2{grid-template-columns:1fr} }

    /* ‚úÖ ADDED: 3-column grid for Level + Cap Color + Tassel Color */
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    @media (max-width:900px){ .grid3{grid-template-columns:1fr} }

    .copyBox{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background:#fff;
    }

    /* ===== ORDERS (right side) ===== */
    #ordersPreview{
      margin-top: 14px;
      padding: 14px 14px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #fff;

      font-size: 20px;      /* laki ng text */
      line-height: 1.55;    /* hindi dikit-dikit */
      font-weight: 800;
      white-space: pre-line; /* respects \n */
    }

    #ordersPreview .hdr{
      font-size: 26px;
      font-weight: 1000;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display:block;
    }

    textarea{
      width:100%;
      min-height:120px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      resize:vertical;
    }
    .foot{margin-top:14px; color:var(--muted); font-size:12px; text-align:center}
    .hidden{display:none!important}

    /* Scanner modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:9999;
    }
    .modal{
      width:min(680px, 100%);
      background:#fff; border-radius:22px; padding:16px;
      border:1px solid var(--border); box-shadow:var(--shadow);
    }
    .modalTop{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px}
    .modalTop b{font-size:18px}
    video{width:100%; border-radius:16px; background:#000}
    .modalHint{color:var(--muted); font-size:13px; margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="title">
            <span class="emoji">üì¶</span>
            <div>
              <h1>Tatak JPD ‚Äî Packing Proof</h1>
              <div class="subtitle">Enter/Scan AWB ‚Üí if no record, create entry ‚Üí copy message</div>
            </div>
          </div>
        </div>
        <button id="btnLogout" class="btn">Logout</button>
      </div>

      <div id="status" class="status ok">Checking login...</div>

      <hr>

      <!-- AWB INPUT -->
      <div>
        <div class="sectionTitle">AWB</div>
        <div class="row">
          <div style="flex:1; min-width:240px">
            <input id="awbInput" type="text" placeholder="Type / paste AWB then press Enter" />
            <div class="hint">Enter = Continue. Sa PC: paste AWB then Enter. Sa phone: Scan or type.</div>
          </div>
          <button id="btnContinue" class="btn">Continue</button>
          <button id="btnScan" class="btn secondary">üì∑ Scan</button>
        </div>
      </div>

      <hr>

      <!-- CREATE FORM -->
      <div id="createSection" class="hidden">
        <div class="sectionTitle">Create Packing Record</div>
        <div class="hint" style="margin-bottom:10px">If first time ng AWB na ‚Äôto, dito ka mag-e-entry ng orders.</div>

        <div id="ordersWrap"></div>

        <div class="row" style="margin-top:10px">
          <button id="btnAddOrder" class="smallBtn">‚ûï Add Order</button>
          <button id="btnRemoveOrder" class="smallBtn">üóëÔ∏è Remove Last</button>
        </div>

        <div id="createError" class="status bad" style="display:none; margin-top:12px;"></div>

        <div class="row" style="margin-top:14px">
          <button id="btnSave" class="btn">Save Packing Log</button>
          <button id="btnCancelCreate" class="btn secondary">Cancel</button>
        </div>
      </div>

      <!-- VIEW RECORD -->
      <div id="viewSection" class="hidden">
        <div class="sectionTitle">Record Found</div>
        <div id="recordMeta" class="hint"></div>

        <div style="margin-top:12px">
          <div class="copyBox">

  <!-- ORDERS FIRST -->
  <div class="hint" id="ordersPreview"></div>

  <b style="margin-top:12px; display:block;">Ready-to-copy message</b>
  <div class="hint" style="margin:8px 0 10px">Click the button para auto-copy (no drag).</div>

  <textarea id="messageBox" readonly></textarea>

  <div class="row" style="margin-top:10px">
    <button id="btnCopyMsg" class="btn">Copy Message</button>
    <button id="btnNewEntry" class="btn secondary">Create new entry anyway</button>
  </div>

</div>
            <div class="hint" id="ordersPreview"></div>
          </div>
        </div>
      </div>

      <hr>

      <!-- DAILY SUMMARY -->
      <div id="dailySection">
        <div class="sectionTitle">üìä Daily Summary</div>
        <div class="hint">Today totals (Kinder/Elem + Colors)</div>

        <div class="row" style="margin-top:10px">
          <button id="btnDaily" class="btn secondary">Load Today Summary</button>
        </div>

        <div id="dailyOutput" class="status" style="margin-top:12px; display:none"></div>
      </div>

      <div class="foot">Private system ‚Äî login required ‚Ä¢ Stored in Firebase (Auth + Firestore)</div>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="scanBack" class="modalBack">
    <div class="modal">
      <div class="modalTop">
        <b>Scan AWB Barcode</b>
        <button id="btnCloseScan" class="smallBtn">Close</button>
      </div>
      <video id="scanVideo" playsinline></video>
      <div class="modalHint">I-tutok sa barcode (J&T / SPX / Flash). Pag na-detect, auto-fill.</div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from "./firebase.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ZXing barcode scanner
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI
    const statusEl = document.getElementById("status");
    const btnLogout = document.getElementById("btnLogout");

    const awbInput = document.getElementById("awbInput");
    const btnContinue = document.getElementById("btnContinue");
    const btnScan = document.getElementById("btnScan");

    const createSection = document.getElementById("createSection");
    const viewSection = document.getElementById("viewSection");

    const ordersWrap = document.getElementById("ordersWrap");
    const btnAddOrder = document.getElementById("btnAddOrder");
    const btnRemoveOrder = document.getElementById("btnRemoveOrder");

    const btnSave = document.getElementById("btnSave");
    const btnCancelCreate = document.getElementById("btnCancelCreate");

    const recordMeta = document.getElementById("recordMeta");
    const messageBox = document.getElementById("messageBox");
    const btnCopyMsg = document.getElementById("btnCopyMsg");
    const btnNewEntry = document.getElementById("btnNewEntry");
    const ordersPreview = document.getElementById("ordersPreview");

    const btnDaily = document.getElementById("btnDaily");
    const dailyOutput = document.getElementById("dailyOutput");

    // Scanner modal
    const scanBack = document.getElementById("scanBack");
    const btnCloseScan = document.getElementById("btnCloseScan");
    const scanVideo = document.getElementById("scanVideo");
    const reader = new BrowserMultiFormatReader();
    let scanStopper = null;

    let currentUser = null;
    let currentAWB = "";
    let currentRecord = null;

    // ---------- helpers ----------
    function setStatus(msg, type="ok"){
      statusEl.className = "status " + type;
      statusEl.textContent = msg;
    }

    const saveError = document.getElementById("createError");
    function showSaveError(msg){
      saveError.textContent = msg;
      saveError.style.display = "block";
    }
    function clearSaveError(){
      saveError.style.display = "none";
      saveError.textContent = "";
    }

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function cleanAWB(s){
      return (s || "").trim().replace(/\s+/g,"");
    }
    function formatDateTime(ts){
      try{
        const d = ts instanceof Date ? ts : new Date(ts);
        return d.toLocaleString([], { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch{ return ""; }
    }

    // ---------- Orders UI (boxes) ----------
    const LEVELS = ["Kinder","Elem"];
    const COLORS = [
      "White","Sky Blue","Fuchsia Pink","Royal Blue","Black","Yellow Gold","Emerald Green","Red","Maroon","Apple Green","Navy blue","Violet","Brown"
    ];

    function pillGroup(options, {multiple=false, name="group"}){
      const wrap = document.createElement("div");
      wrap.className = "pillRow";

      options.forEach((opt) => {
        const label = document.createElement("label");
        label.className = "pill";
        const input = document.createElement("input");
        input.type = multiple ? "checkbox" : "radio";
        input.name = name;
        input.value = opt;

        label.appendChild(input);
        label.appendChild(document.createTextNode(opt));

        label.addEventListener("click", (e) => {
          e.preventDefault(); // stop double-toggle
          if (!multiple){
            wrap.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
            label.classList.add("active");
            input.checked = true;
          }else{
            input.checked = !input.checked;
            label.classList.toggle("active", input.checked);
          }
          const m = String(name || "").match(/^((level|color))_(\d+)$/);
          if (m) autoFocusQtyIfReady(Number(m[3]));
        });

        wrap.appendChild(label);
      });
      return wrap;
    }

    function createOrderBox(orderIndex){
      const box = document.createElement("div");
      box.className = "orderBox";
      box.dataset.orderIndex = String(orderIndex);

      const header = document.createElement("div");
      header.className = "orderHeader";
      header.innerHTML = `<div>Order #${orderIndex + 1}</div><div style="color:#6b7280;font-weight:900">pick level(s) + 1 color</div>`;
      box.appendChild(header);

      const grid = document.createElement("div");
      grid.className = "grid3";

      const left = document.createElement("div");
      left.innerHTML = `<label>LEVEL</label>`;
      const levelGroup = pillGroup(LEVELS, { multiple:false, name:`level_${orderIndex}` });
      left.appendChild(levelGroup);

      const mid = document.createElement("div");
      mid.innerHTML = `<label>CAP COLOR</label>`;
      const capColorGroup = pillGroup(COLORS, { multiple:false, name:`color_${orderIndex}` });
      mid.appendChild(capColorGroup);

      const right = document.createElement("div");
      right.innerHTML = `
        <label>TASSEL COLOR <span style="font-weight:800;color:#6b7280">(Optional)</span></label>
        <div class="hint" style="margin:-2px 0 8px">Leave blank = same as cap color. Click only if customized.</div>
      `;
      const tasselGroup = pillGroup(COLORS, { multiple:false, name:`tassel_${orderIndex}` });
      right.appendChild(tasselGroup);

      grid.appendChild(left);
      grid.appendChild(mid);
      grid.appendChild(right);
      box.appendChild(grid);

      // quantity
      const qtyWrap = document.createElement("div");
      qtyWrap.style.marginTop = "12px";
      qtyWrap.innerHTML = `
        <label>Quantity (pairs / pcs)</label>
        <input type="text" inputmode="numeric" placeholder="e.g. 36" data-role="qty" />
        <div class="hint">Optional: lagay mo ilan total sa order na ‚Äôto.</div>
      `;
      box.appendChild(qtyWrap);

      return box;
    }

    function ensureAtLeastOneOrder(){
      if (ordersWrap.children.length === 0){
        ordersWrap.appendChild(createOrderBox(0));
      }
    }

    function autoFocusQtyIfReady(orderIndex){
      const box = ordersWrap.querySelector(`.orderBox[data-order-index="${orderIndex}"]`);
      if (!box) return;

      const lvl = box.querySelector(`input[name="level_${orderIndex}"]:checked`);
      const col = box.querySelector(`input[name="color_${orderIndex}"]:checked`);
      if (lvl && col){
        const qtyInput = box.querySelector('input[data-role="qty"]');
        qtyInput?.focus?.();
      }
    }

    function readOrdersFromUI(){
      const orders = [];
      [...ordersWrap.children].forEach((box) => {
        const idx = Number(box.dataset.orderIndex || "0");

        const levels = [];
        box.querySelectorAll(`input[name="level_${idx}"]`).forEach((i) => {
          if (i.checked) levels.push(i.value);
        });

        let capColor = "";
        box.querySelectorAll(`input[name="color_${idx}"]`).forEach((i) => {
          if (i.checked) capColor = i.value;
        });

        let tasselColor = "";
        box.querySelectorAll(`input[name="tassel_${idx}"]`).forEach((i) => {
          if (i.checked) tasselColor = i.value;
        });

        const qtyInput = box.querySelector('input[data-role="qty"]');
        const qtyRaw = (qtyInput?.value || "").trim();
        const qty = qtyRaw ? Number(qtyRaw.replace(/[^\d]/g,"")) : null;

        const finalTassel = tasselColor || capColor;
        const tasselCustomized = !!tasselColor && (tasselColor !== capColor);

        orders.push({
          levels,
          color: capColor,
          tasselColor: finalTassel,
          tasselCustomized,
          qty: Number.isFinite(qty) && qty > 0 ? qty : null
        });
      });

      return orders;
    }

    function summarizeOrders(orders){
      if (!orders?.length) return "No order details.";
      return orders.map((o, i) => {
        const lvl = (o.levels?.length ? o.levels.join("+") : "No level");
        const cap = (o.color || "No cap color");
        const qty = (o.qty ? `qty ${o.qty}` : "qty -");

        const tasselPart = (o.tasselCustomized && o.tasselColor)
          ? ` ‚Ä¢ Tassel: ${o.tasselColor}`
          : "";

        return `#${i+1} ${lvl} ‚Ä¢ Cap: ${cap}${tasselPart} ‚Ä¢ ${qty}`;
      }).join("\n");
    }

    // ---------- Auth ----------
    onAuthStateChanged(auth, (user) => {
      if (!user){
        window.location.href = "./login.html";
        return;
      }
      currentUser = user;
      setStatus(`‚úÖ Logged in as: ${user.email}`, "ok");
      ensureAtLeastOneOrder();
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "./login.html";
    });

    // ---------- Core flow ----------
    async function findOrCreateFlow(awb){
      currentAWB = cleanAWB(awb);
      if (!currentAWB){
        setStatus("‚ö†Ô∏è Please enter an AWB.", "warn");
        return;
      }

      hide(viewSection);
      hide(createSection);
      setStatus("Checking record...", "ok");

      const docRef = doc(db, "packingLogs", currentAWB);
      const snap = await getDoc(docRef);

      if (snap.exists()){
        currentRecord = snap.data();
        await renderRecord(currentAWB, currentRecord);

        setStatus("‚úÖ Existing record found.", "ok");
        hide(createSection);
        show(viewSection);
      } else {
        currentRecord = null;
        setStatus("No record found ‚Üí creating new entry.", "ok");
        resetCreateForm();
        show(createSection);
        hide(viewSection);
      }
    }

    function resetCreateForm(){
      // Keep orders as-is (so mabilis)
    }

    btnContinue.addEventListener("click", () => findOrCreateFlow(awbInput.value));
    awbInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        findOrCreateFlow(awbInput.value);
      }
    });

    btnNewEntry.addEventListener("click", () => {
      setStatus("‚ö†Ô∏è Creating new entry anyway (will overwrite same AWB).", "warn");
      show(createSection);
      hide(viewSection);
    });

    btnCancelCreate.addEventListener("click", () => {
      hide(createSection);
      setStatus("Ready. Enter/Scan AWB.", "ok");
    });

    // Orders add/remove
    btnAddOrder.addEventListener("click", () => {
      const idx = ordersWrap.children.length;
      ordersWrap.appendChild(createOrderBox(idx));
    });
    btnRemoveOrder.addEventListener("click", () => {
      if (ordersWrap.children.length > 1){
        ordersWrap.removeChild(ordersWrap.lastElementChild);
      }
    });

    // ---------- Save (Firestore) ----------
    btnSave.addEventListener("click", async () => {
      try{
        const awb = cleanAWB(awbInput.value || currentAWB);
        if (!awb){
          setStatus("‚ö†Ô∏è AWB required.", "warn");
          return;
        }
        currentAWB = awb;

        const orders = readOrdersFromUI();
        const ordersText = summarizeOrders(orders);

        clearSaveError();

        // ‚úÖ strict validation (same as your rules)
        for (let i = 0; i < orders.length; i++) {
          const o = orders[i];

          if (!o.levels || o.levels.length !== 1) {
            showSaveError(`‚ùå Order #${i + 1}: Please select ONE level (Kinder / Elem).`);
            return;
          }
          if (!o.color) {
            showSaveError(`‚ùå Order #${i + 1}: Please select ONE color.`);
            return;
          }
          if (!o.qty || !Number.isFinite(o.qty) || o.qty < 1) {
            showSaveError(`‚ùå Order #${i + 1}: Quantity is required (minimum 1).`);
            return;
          }
        }

        btnSave.disabled = true;
        btnSave.textContent = "Saving...";

        const docRef = doc(db, "packingLogs", awb);

        const payload = {
          awb,
          orders,
          ordersText,

          createdAt: currentRecord?.createdAt || serverTimestamp(),
          createdByUid: currentRecord?.createdByUid || currentUser.uid,
          createdByEmail: currentRecord?.createdByEmail || (currentUser.email || ""),

          updatedAt: serverTimestamp()
        };

        await setDoc(docRef, payload, { merge: true });

        setStatus("‚úÖ Saved! Opening record‚Ä¶", "ok");

        const snap = await getDoc(docRef);
        currentRecord = snap.data();
        await renderRecord(awb, currentRecord);

        hide(createSection);
        show(viewSection);

      }catch(err){
        console.error(err);
        setStatus("‚ùå Save error:\n" + (err?.message || err), "bad");
      }finally{
        btnSave.disabled = false;
        btnSave.textContent = "Save Packing Log";
      }
    });

    // ---------- Render record + copy ----------
    async function renderRecord(awb, rec){
      let dt = "";
      try{
        const createdAt = rec?.createdAt?.toDate ? rec.createdAt.toDate() : null;
        const updatedAt = rec?.updatedAt?.toDate ? rec.updatedAt.toDate() : null;
        dt = createdAt ? formatDateTime(createdAt) : (updatedAt ? formatDateTime(updatedAt) : "");
      }catch{}

      const ordersText = rec?.ordersText || summarizeOrders(rec?.orders || []);
      recordMeta.textContent = `AWB: ${awb} ‚Ä¢ ${dt ? ("Saved: " + dt + " ‚Ä¢ ") : ""}By: ${rec?.createdByEmail || "-"}`;

      const nowText = dt || formatDateTime(new Date());
      const msg =
`üì¶ AWB: ${awb}
üïí Packed: ${nowText}`;
      messageBox.value = msg;

      ordersPreview.innerHTML =
        `<span class="hdr">ORDERS:</span>` + (ordersText || "‚Äî");
    }

    btnCopyMsg.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(messageBox.value);
        setStatus("‚úÖ Message copied!", "ok");
      }catch{
        messageBox.focus();
        messageBox.select();
        document.execCommand("copy");
        setStatus("‚úÖ Message copied (fallback)!", "ok");
      }
    });

    // ---------- Scanner ----------
    btnScan.addEventListener("click", async () => {
      try{
        scanBack.style.display = "flex";
        setStatus("Scanning‚Ä¶", "ok");

        await reader.decodeFromVideoDevice(
          undefined,
          scanVideo,
          (res, err, controls) => {
            if (controls && !scanStopper) scanStopper = controls;
            if (res?.getText){
              const code = cleanAWB(res.getText());
              if (code){
                awbInput.value = code;
                closeScanner();
                findOrCreateFlow(code);
              }
            }
          }
        );

      }catch(err){
        console.error(err);
        setStatus("‚ö†Ô∏è Camera scan not available. You can paste/type AWB then Enter.", "warn");
        scanBack.style.display = "none";
      }
    });

    function closeScanner(){
      scanBack.style.display = "none";
      try{ scanStopper?.stop?.(); }catch{}
      scanStopper = null;
      try{ reader.reset(); }catch{}
    }
    btnCloseScan.addEventListener("click", closeScanner);
    scanBack.addEventListener("click", (e) => {
      if (e.target === scanBack) closeScanner();
    });

    // ---------- DAILY SUMMARY ----------
    function showDaily(text, type="ok"){
      dailyOutput.style.display = "block";
      dailyOutput.className = "status " + type;
      dailyOutput.textContent = text;
    }

    btnDaily.addEventListener("click", async () => {
      try {
        btnDaily.disabled = true;
        btnDaily.textContent = "Loading...";

        function pad2(n){ return String(n).padStart(2,"0"); }
        function dayKey(d){
          return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        }
        function niceDayLabel(d){
          return d.toLocaleDateString([], { month:"short", day:"2-digit" });
        }
        function inc(obj, key, by=1){
          if (!key) return;
          obj[key] = (obj[key] || 0) + by;
        }
        function normalizeLevel(o){
          const lvls = Array.isArray(o?.levels) ? o.levels : [];
          if (lvls.includes("Kinder")) return "Kinder";
          if (lvls.includes("Elem")) return "Elem";
          return null;
        }
        function getQty(o){
          const q = Number(o?.qty);
          return Number.isFinite(q) && q > 0 ? q : 1;
        }

        const startToday = new Date(); startToday.setHours(0,0,0,0);
        const endToday = new Date(); endToday.setHours(23,59,59,999);

        const start7 = new Date(); start7.setHours(0,0,0,0);
        start7.setDate(start7.getDate() - 6);
        const end7 = new Date(); end7.setHours(23,59,59,999);

        const logsRef = collection(db, "packingLogs");
        const q7 = query(
          logsRef,
          where("updatedAt", ">=", start7),
          where("updatedAt", "<=", end7)
        );

        const snap7 = await getDocs(q7);

        const levelCounts = {};
        const colorCounts = {};
        let totalRecordsToday = 0;

        const dayKinder = {};
        const dayElem = {};
        let totalKinder7 = 0;
        let totalElem7 = 0;
        let totalPcs7 = 0;

        snap7.forEach((docu) => {
          const data = docu.data();
          const upd = data?.updatedAt?.toDate ? data.updatedAt.toDate() : null;
          if (!upd) return;

          const k = dayKey(upd);
          const orders = Array.isArray(data.orders) ? data.orders : [];

          orders.forEach((o) => {
            const qty = getQty(o);
            totalPcs7 += qty;

            const lvl = normalizeLevel(o);
            if (lvl === "Kinder"){
              dayKinder[k] = (dayKinder[k] || 0) + qty;
              totalKinder7 += qty;
            } else if (lvl === "Elem"){
              dayElem[k] = (dayElem[k] || 0) + qty;
              totalElem7 += qty;
            }
          });

          if (upd >= startToday && upd <= endToday){
            totalRecordsToday++;
            orders.forEach((o) => {
              const qty = getQty(o);
              const lvl = normalizeLevel(o);
              if (lvl) inc(levelCounts, lvl, qty);
              if (o?.color) inc(colorCounts, o.color, qty);
            });
          }
        });

        const dateStr = new Date().toLocaleDateString([], {
          year:"numeric", month:"short", day:"2-digit"
        });

        const lvlLines = ["Kinder","Elem"]
          .map(k => `‚Ä¢ ${k}: ${levelCounts[k] || 0}`)
          .join("\n");

        const colorLines = [
          "White","Sky Blue","Fuchsia Pink","Royal Blue","Black","Yellow Gold",
          "Emerald Green","Red","Maroon","Apple Green","Navy blue","Violet","Brown"
        ].map(c => `‚Ä¢ ${c}: ${colorCounts[c] || 0}`).join("\n");

        const kinderLines = [];
        const elemLines = [];

        for (let i=0;i<7;i++){
          const d = new Date(start7);
          d.setDate(start7.getDate()+i);
          const key = dayKey(d);
          kinderLines.push(`${niceDayLabel(d)} - ${(dayKinder[key] || 0)} pcs`);
          elemLines.push(`${niceDayLabel(d)} - ${(dayElem[key] || 0)} pcs`);
        }

        showDaily(
`üìÖ Today: ${dateStr}
üì¶ Records saved today: ${totalRecordsToday}

üè´ LEVEL TOTALS (any color)
${lvlLines}

üé® COLOR TOTALS (any level)
${colorLines}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üóìÔ∏è LAST 7 DAYS TOTAL PCS: ${totalPcs7} pcs

KINDER (7 days): ${totalKinder7} pcs
${kinderLines.join("\n")}

ELEM (7 days): ${totalElem7} pcs
${elemLines.join("\n")}`,
"ok");

      } catch (err) {
        console.error(err);
        showDaily("‚ùå Daily summary error:\n" + (err?.message || err), "bad");
      } finally {
        btnDaily.disabled = false;
        btnDaily.textContent = "Load Today Summary";
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tatak JPD Packing Logs</title>
</head>
<body>

<h2>Scan / Enter AWB</h2>
<input id="awb" placeholder="AWB Number"><br><br>

<input type="file" id="photo"><br><br>
<button onclick="saveLog()">Save Packing Log</button>

<hr>

<h3>Search AWB</h3>
<input id="searchAwb" placeholder="Enter AWB">
<button onclick="search()">Search</button>

<div id="result"></div>

<br><button onclick="logout()">Logout</button>

<script src="firebase.js"></script>

<script type="module">
  import {
    collection, addDoc, query, where, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  import {
    ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  import {
    signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  onAuthStateChanged(auth, user => {
    if (!user) window.location.href = "login.html";
  });

  window.saveLog = async function () {
    const awb = document.getElementById("awb").value;
    const file = document.getElementById("photo").files[0];
    const user = auth.currentUser;

    if (!awb || !file) {
      alert("AWB at photo required");
      return;
    }

    const fileRef = ref(storage, `packingProofs/${user.uid}/${awb}.jpg`);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);

    await addDoc(collection(db, "packingLogs"), {
      awb,
      photoUrl: url,
      uid: user.uid,
      createdAt: serverTimestamp()
    });

    alert("Saved!");
  };

  window.search = async function () {
    const awb = document.getElementById("searchAwb").value;
    const q = query(
      collection(db, "packingLogs"),
      where("awb", "==", awb)
    );

    const snap = await getDocs(q);
    const res = document.getElementById("result");
    res.innerHTML = "";

    snap.forEach(doc => {
      res.innerHTML += `<img src="${doc.data().photoUrl}" width="200"><br>`;
    });
  };

  window.logout = function () {
    signOut(auth);
  };
</script>

</body>
</html>
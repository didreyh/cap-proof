<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tatak JPD — Packing Logs</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f5f6f8; margin:0; padding:24px;}
    .card{max-width:760px; margin:24px auto; background:#fff; border-radius:18px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.08);}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .title h1{margin:0; font-size:26px;}
    .title .sub{color:#666; margin-top:4px;}
    .pill{background:#eaf7ee; border:1px solid #bfe6c9; color:#1b5e20; padding:10px 12px; border-radius:12px; font-weight:700; margin-top:14px;}
    .btn{padding:10px 14px; border-radius:14px; border:0; font-weight:800; cursor:pointer;}
    .btn-dark{background:#111; color:#fff;}
    .btn-light{background:#fff; color:#111; border:1px solid #ddd;}
    h2{margin:18px 0 8px;}
    label{display:block; margin:10px 0 6px; font-weight:700;}
    input{width:100%; padding:14px 12px; border:1px solid #ddd; border-radius:12px; font-size:16px; outline:none;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .row > *{flex:1}
    .hint{color:#666; margin-top:6px; font-size:14px;}
    .status{margin-top:10px; font-weight:800;}
    .muted{color:#777;}
    .preview{margin-top:12px; border:1px dashed #ddd; border-radius:16px; padding:12px; min-height:180px; display:flex; align-items:center; justify-content:center; background:#fafafa;}
    img{max-width:100%; border-radius:14px;}
    .resultCard{margin-top:12px; padding:12px; border:1px solid #eee; border-radius:14px; background:#fafafa;}
    .foot{margin-top:18px; color:#777; text-align:center; font-size:13px;}
    button:disabled{opacity:.55; cursor:not-allowed;}
  </style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div class="title">
        <h1>✅ Tatak JPD</h1>
        <div class="sub">Cap Packing & AWB Proof System</div>
      </div>
      <button id="btnLogout" class="btn btn-dark">Logout</button>
    </div>

    <div id="who" class="pill">Checking login…</div>

    <hr style="border:none;border-top:1px solid #eee;margin:16px 0;" />

    <h2>Save Packing Log (Photo)</h2>

    <label>AWB Number</label>
    <input id="awbInput" type="text" placeholder="Type/paste AWB (or scan barcode)" />

    <label>Upload Photo Proof</label>
    <input id="photoInput" type="file" accept="image/*" capture="environment" />
    <div class="hint">Tip: picture only para mabilis mag-save. Pwede mo i-timelapse sa phone then screenshot frames kung need.</div>

    <div class="preview" id="previewBox">
      <span class="muted">Preview will show here…</span>
    </div>

    <div class="row">
      <button id="btnSave" class="btn btn-dark">Save Packing Log</button>
      <button id="btnClear" class="btn btn-light">Clear</button>
    </div>

    <div id="saveStatus" class="status muted"></div>

    <hr style="border:none;border-top:1px solid #eee;margin:18px 0;" />

    <h2>Search / View Logs</h2>

    <label>Search by AWB</label>
    <input id="searchAwb" type="text" placeholder="Type/paste AWB then Search" />

    <div class="row">
      <button id="btnSearch" class="btn btn-light">Search</button>
    </div>

    <div id="searchResult"></div>

    <div class="foot">
      Private system — login required • Stored in Firebase (Auth + Firestore + Storage)
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from "./firebase.js";

    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    import {
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    import {
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const whoEl = document.getElementById("who");
    const btnLogout = document.getElementById("btnLogout");

    const awbInput = document.getElementById("awbInput");
    const photoInput = document.getElementById("photoInput");
    const previewBox = document.getElementById("previewBox");

    const btnSave = document.getElementById("btnSave");
    const btnClear = document.getElementById("btnClear");
    const saveStatus = document.getElementById("saveStatus");

    const searchAwb = document.getElementById("searchAwb");
    const btnSearch = document.getElementById("btnSearch");
    const searchResult = document.getElementById("searchResult");

    let currentUser = null;

    // ✅ Protect page: if not logged in → login.html
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "./login.html";
        return;
      }
      currentUser = user;
      whoEl.textContent = `Logged in as: ${user.email}`;
    });

    // Logout
    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "./login.html";
    });

    // Preview photo
    photoInput.addEventListener("change", () => {
      const file = photoInput.files[0];
      if (!file) {
        previewBox.innerHTML = `<span class="muted">Preview will show here…</span>`;
        return;
      }
      const url = URL.createObjectURL(file);
      previewBox.innerHTML = `<img src="${url}" alt="preview" />`;
    });

    // Clear
    btnClear.addEventListener("click", () => {
      awbInput.value = "";
      photoInput.value = "";
      previewBox.innerHTML = `<span class="muted">Preview will show here…</span>`;
      saveStatus.textContent = "";
    });

    // ✅ Save packing log (Photo only)
    btnSave.addEventListener("click", async () => {
      const awb = awbInput.value.trim();
      const file = photoInput.files[0];

      if (!awb || !file) {
        alert("AWB + picture required.");
        return;
      }
      if (!currentUser) return;

      btnSave.disabled = true;
      saveStatus.textContent = "Uploading photo + saving…";
      saveStatus.classList.remove("muted");

      try {
        // Upload file to Storage
        const filePath = `packingPhotos/${awb}.jpg`;
        const storageRef = ref(storage, filePath);
        await uploadBytes(storageRef, file);
        const photoURL = await getDownloadURL(storageRef);

        // Save doc using AWB as document ID (super easy search)
        await setDoc(doc(db, "packingLogs", awb), {
          awb,
          photoURL,
          filePath,
          createdBy: currentUser.email,
          createdAt: serverTimestamp()
        }, { merge: true });

        saveStatus.textContent = "✅ Saved!";
        setTimeout(() => (saveStatus.textContent = ""), 2500);

      } catch (e) {
        console.error(e);
        alert("❌ Save failed. Check Firestore rules + Storage rules.");
        saveStatus.textContent = "❌ Error saving.";
      } finally {
        btnSave.disabled = false;
      }
    });

    // ✅ Search (works kahit wala scan)
    btnSearch.addEventListener("click", async () => {
      const awb = searchAwb.value.trim();
      if (!awb) return;

      searchResult.innerHTML = `<div class="resultCard">Searching…</div>`;

      try {
        const snap = await getDoc(doc(db, "packingLogs", awb));

        if (!snap.exists()) {
          searchResult.innerHTML = `<div class="resultCard">❌ No record found for <b>${awb}</b></div>`;
          return;
        }

        const d = snap.data();
        searchResult.innerHTML = `
          <div class="resultCard">
            <div><b>AWB:</b> ${d.awb}</div>
            <div style="margin-top:10px;">
              <img src="${d.photoURL}" alt="proof" style="max-width:100%;border-radius:14px;" />
            </div>
          </div>
        `;
      } catch (e) {
        console.error(e);
        searchResult.innerHTML = `<div class="resultCard">❌ Error searching.</div>`;
      }
    });
  </script>
</body>
</html>
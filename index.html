<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tatak JPD â€“ Packing Proof</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;background:#f5f6f8;padding:20px}
.card{background:#fff;padding:20px;border-radius:20px;max-width:900px;margin:auto;box-shadow:0 10px 30px rgba(0,0,0,.1)}
button,input{padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px}
button{background:#000;color:#fff;border:none;cursor:pointer}
button.secondary{background:#fff;color:#000;border:1px solid #ccc}
.status{margin:10px 0;padding:10px;border-radius:10px}
.ok{background:#ecfdf5}
.bad{background:#fef2f2}
.warn{background:#fffbeb}
.hidden{display:none}
.pill{display:inline-block;padding:8px 12px;border:1px solid #ccc;border-radius:20px;margin:4px;cursor:pointer}
.pill.active{background:#000;color:#fff}
.orderBox{border:1px dashed #ccc;padding:12px;border-radius:12px;margin-top:10px}
</style>
</head>

<body>

<div class="card">
<h2>ðŸ“¦ Tatak JPD â€“ Packing Proof</h2>

<div id="status" class="status ok">Checking loginâ€¦</div>

<!-- AWB -->
<input id="awbInput" placeholder="Enter AWB then press Enter">
<button id="btnContinue">Continue</button>

<hr>

<!-- CREATE -->
<div id="createSection" class="hidden">
<h3>Create Order</h3>

<div id="ordersWrap"></div>

<button id="addOrder" class="secondary">+ Add Order</button>

<br><br>
<label>Photo Proof (required)</label>
<input type="file" id="photoInput" accept="image/*">

<br><br>
<button id="saveBtn">Save</button>
</div>

<!-- VIEW -->
<div id="viewSection" class="hidden">
<h3>Record Found</h3>
<img id="previewImg" style="max-width:100%;border-radius:10px"><br><br>

<textarea id="messageBox" style="width:100%;height:120px"></textarea><br><br>
<button id="copyMsg">Copy Message</button>
</div>

<hr>

<!-- DAILY SUMMARY -->
<h3>ðŸ“Š Daily Summary</h3>
<button id="loadDaily" class="secondary">Load Today</button>
<pre id="dailyOutput" class="status hidden"></pre>

</div>

<script type="module">
import { firebaseConfig } from "./firebase.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const LEVELS = ["Kinder","Elem","SHS"];
const COLORS = ["White","Light Blue","Fuchsia Pink","Royal Blue","Black","Yellow Gold","Emerald Green","Red","Maroon","Apple Green"];

const ordersWrap = document.getElementById("ordersWrap");
const status = document.getElementById("status");

function createOrderBox(i){
  const box=document.createElement("div");
  box.className="orderBox";
  box.dataset.i=i;

  box.innerHTML=`
  <b>Order #${i+1}</b><br><br>

  <b>Level (one)</b><br>
  ${LEVELS.map(l=>`<span class="pill level">${l}</span>`).join("")}

  <br><br><b>Color (one)</b><br>
  ${COLORS.map(c=>`<span class="pill color">${c}</span>`).join("")}

  <br><br>
  <input type="number" min="1" placeholder="Quantity (required)" class="qty">
  `;

  box.querySelectorAll(".level").forEach(p=>{
    p.onclick=()=>{
      box.querySelectorAll(".level").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
    }
  });

  box.querySelectorAll(".color").forEach(p=>{
    p.onclick=()=>{
      box.querySelectorAll(".color").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
    }
  });

  return box;
}

function readOrders(){
  const orders=[];
  ordersWrap.querySelectorAll(".orderBox").forEach(b=>{
    const level=b.querySelector(".level.active")?.textContent;
    const color=b.querySelector(".color.active")?.textContent;
    const qty=Number(b.querySelector(".qty").value);

    if(!level||!color||!qty){
      throw "All orders must have level, color, and quantity.";
    }

    orders.push({level,color,qty});
  });
  return orders;
}

ordersWrap.appendChild(createOrderBox(0));

document.getElementById("addOrder").onclick=()=>{
  ordersWrap.appendChild(createOrderBox(ordersWrap.children.length));
};

document.getElementById("btnContinue").onclick=async()=>{
  const awb=awbInput.value.trim();
  if(!awb) return;

  const refDoc=doc(db,"packingLogs",awb);
  const snap=await getDoc(refDoc);

  if(snap.exists()){
    const d=snap.data();
    viewSection.classList.remove("hidden");
    createSection.classList.add("hidden");
    previewImg.src=d.photoUrl;
    messageBox.value=`Hi po! Ready to ship na po ang order nyo.\nAWB: ${awb}`;
  }else{
    createSection.classList.remove("hidden");
    viewSection.classList.add("hidden");
  }
};

document.getElementById("saveBtn").onclick=async()=>{
  try{
    const awb=awbInput.value.trim();
    const orders=readOrders();
    const file=photoInput.files[0];
    if(!file) throw "Photo is required";

    const sref=ref(storage,`proofs/${awb}.jpg`);
    await uploadBytes(sref,file);
    const url=await getDownloadURL(sref);

    await setDoc(doc(db,"packingLogs",awb),{
      awb,orders,photoUrl:url,updatedAt:serverTimestamp()
    });

    status.textContent="Saved successfully";
    status.className="status ok";
  }catch(e){
    status.textContent=e;
    status.className="status bad";
  }
};

document.getElementById("loadDaily").onclick=async()=>{
  const start=new Date();start.setHours(0,0,0,0);
  const end=new Date();end.setHours(23,59,59,999);

  const q=query(collection(db,"packingLogs"),
    where("updatedAt",">=",start),
    where("updatedAt","<=",end));

  const snap=await getDocs(q);

  const lvl={Kinder:0,Elem:0,SHS:0};
  const col={};

  COLORS.forEach(c=>col[c]=0);

  snap.forEach(d=>{
    d.data().orders.forEach(o=>{
      lvl[o.level]+=o.qty;
      col[o.color]+=o.qty;
    });
  });

  dailyOutput.textContent=
`LEVELS
${Object.entries(lvl).map(([k,v])=>`${k}: ${v}`).join("\n")}

COLORS
${Object.entries(col).map(([k,v])=>`${k}: ${v}`).join("\n")}`;

  dailyOutput.classList.remove("hidden");
};
</script>
</body>
</html>